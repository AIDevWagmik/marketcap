<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Basic SEO -->
<title>MCAP Cult - Put on your MCAP, and join the cult</title>
<meta name="description" content="Join the MCAP cult. Buy your cap, swap $MCAP, check live charts, explore memes, and create your own MCAP hat edits right in your browser.">
<meta name="keywords" content="MCAP, Solana, memecoin, crypto, hat, meme, swap, dexscreener, Solana token">
<meta name="author" content="MCAP Team">

<!-- Open Graph (for Discord, Facebook, LinkedIn) -->
<meta property="og:title" content="Put on your MCAP, and join the cult">
<meta property="og:description" content="Buy your cap, swap $MCAP, check live charts, explore memes, and create your own MCAP hat edits.">
<meta property="og:image" content="https://yourwebsite.com/hat.png">
<meta property="og:url" content="https://yourwebsite.com/">
<meta property="og:type" content="website">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Put on your MCAP, and join the cult">
<meta name="twitter:description" content="Join the MCAP cult and create your own MCAP hat edits.">
<meta name="twitter:image" content="https://yourwebsite.com/hat.png">

<!-- Favicon -->
<link rel="icon" type="image/png" href="hat.png">

  <!-- Jupiter Plugin (modal) -->
  <script src="https://plugin.jup.ag/plugin-v1.js" data-preload defer></script>
  <style>
/* === MCAP color overrides — paste at END of <style> === */
:root {
  --blue-bg: #bde9ff;     /* Page background & hats */
  --blue-title: #2877cd;  /* Section titles & buttons */
  --colW: 220px;
}

* { box-sizing: border-box; }
html, body { margin: 0; padding: 0; height: 100%; }

body {
  min-height: 100vh;
  color: #fff;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  position: relative;
  overflow-x: hidden;
  background-color: var(--blue-bg); /* stays light */
}

    /* HATS BACKGROUND: continuous top->bottom motion */
    .hat-bg {
      position: fixed;
      top: 0; bottom: 0;
      left: var(--colW);
      right: var(--colW);
      pointer-events: none;
      z-index: 1;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      grid-auto-rows: 350px;
      justify-items: center;
      align-items: center;
      will-change: transform;
      animation: hatsScroll 20s linear infinite;
    }
    .hat-bg img {
      width: 100%;
      max-width: 350px;
      height: auto;
      image-rendering: high-quality;
      opacity: 1;
    }

    /* SIDE COLUMNS: animated loop from top to bottom (not tied to page scroll) */
    #side-columns {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 2;
    }
    #side-columns .col {
      position: absolute;
      top: 0; bottom: 0;
      width: var(--colW);
      background-image: url('mcap.png');
      background-repeat: repeat-y;
      background-size: contain;
      opacity: 0.18;
      animation: columnsScroll 22s linear infinite;
      will-change: background-position;
    }
    #side-columns .left { left: 0; }
    #side-columns .right { right: 0; }

    header, main, footer { position: relative; z-index: 3; }

    header img { width: 100%; height: auto; display: block; }

    main {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem 1rem;
      padding-left: calc(1rem + var(--colW));
      padding-right: calc(1rem + var(--colW));
      text-align: center;
      gap: 2rem;
    }

    .app-section h2,
.jupiter-section h2 {
  display: inline-block;
  background: var(--blue-title);
  color: #fff;
  border-radius: 9999px;
  padding: 0.5rem 0.9rem;
}

    .market-section {
      width: 100%;
      max-width: 800px;
      background: #ffffff;
      color: #000;
      border-radius: 16px;
      overflow: hidden;
      margin: 0 auto;
      background: var(--blue-title);
    }
    .market-section h2 {
      margin: 0;
      padding: 0.85rem 1rem;
      background: var(--blue);
      color: #fff;
      font-size: 1.4rem;
      text-align: center;
    }

    #dexscreener-embed { position: relative; width: 100%; padding-bottom: 80%; }
    @media (min-width: 1400px) {
      #dexscreener-embed { padding-bottom: 50%; }
    }
    #dexscreener-embed iframe {
      position: absolute; width: 100%; height: 100%; top: 0; left: 0; border: 0;
    }

    .app-launch-wrap { display: flex; justify-content: center; padding: 1.25rem 0; }
    .app-launch {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      gap: 0.75rem;
      text-decoration: none;
      color: #fff;
    }
    .app-launch img {
      width: clamp(110px, 28vw, 200px);
      height: auto;
      display: block;
      border-radius: 24px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.25);
      background: #ffffff;
    }

    /* Simple CTA button for opening Jupiter modal */
    #open-jup { cursor:pointer; background: var(--blue); color:#fff; border:none; border-radius:9999px; padding:0.6rem 1rem; font-weight:700; }

    footer img { width: 100%; height: auto; display: block; }

    /* Animations */
    @keyframes columnsScroll { from { background-position-y: 0; } to { background-position-y: 1000px; } }
    @keyframes hatsScroll { from { transform: translateY(0); } to { transform: translateY(200px); } }

    @media (max-width: 480px) {
      #side-columns { display: none; }
      .hat-bg { left: 0; right: 0; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); grid-auto-rows: 150px; }
      main { padding: 1.25rem; }
      h1 { font-size: 1.4rem; }
      .app-section h2, .jupiter-section h2 { font-size: 1.05rem; }
      .market-section { max-width: 100%; border-radius: 12px; }
      .market-section h2 { font-size: 1.15rem; }
    }

    .memes-section {
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
}

.memes-section h2 {
  display: inline-block;
  margin: 0 auto 1rem auto;
  padding: 0.5rem 0.9rem;
  background: var(--blue-title);
  color: #fff;
  font-size: 1.15rem;
  text-align: center;
  border-radius: 9999px;
}

.memes-scroll {
  position: relative;
  width: 100%;
  overflow: hidden;
}

.memes-track {
  display: flex;
  gap: 1rem;
  animation: scrollMemes 40s linear infinite;
}

.memes-track img {
  width: 200px;
  height: 200px;
  object-fit: cover;
  border-radius: 12px;
  flex-shrink: 0;
  cursor: pointer;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.memes-track img:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 18px rgba(0,0,0,0.3);
}

/* Continuous loop with no reset jump */
@keyframes scrollMemes {
  0% { transform: translateX(0); }
  100% { transform: translateX(-50%); }
}

/* Fullscreen meme modal */
#meme-modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  justify-content: center;
  align-items: center;
  z-index: 999;
}

#meme-modal img {
  max-width: 90%;
  max-height: 90%;
  border-radius: 12px;
}

#meme-close {
  position: absolute;
  top: 20px;
  right: 30px;
  font-size: 2rem;
  color: white;
  cursor: pointer;
}

/* Canvas section styling (uses your dark blue, with fallback) */
.canvas-section {
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
  color: #fff;
}
.canvas-section h2{
  display:inline-block;
  margin:0 auto 1rem auto;
  padding:0.5rem 0.9rem;
  background: var(--blue-title, #2877cd);
  color:#fff;
  border-radius:9999px;
  font-size:1.15rem;
  text-align:center;
}

.canvas-controls{
  display:flex;
  gap:0.75rem;
  justify-content:center;
  flex-wrap:wrap;
  margin-bottom:0.75rem;
}
.btn, .file-btn{
  background: var(--blue-title, #2877cd);
  color:#fff;
  border:none;
  border-radius:9999px;
  padding:0.55rem 1rem;
  font-weight:700;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  justify-content:center;
}
.file-btn input{ display:none; }
.btn-ghost{
  background: transparent;
  color:#fff;
  border:2px solid rgba(255,255,255,0.7);
}
.canvas-wrap{
  position:relative;
  width:100%;
  max-width: 100%;
  display:flex;
  justify-content:center;
  align-items:center;
  /* Critical: prevent browser panning/zooming while touching canvas */
  touch-action: none;
  user-select:none;
}
#hatCanvas{
  width: min(100%, 1000px);
  height: auto;
  background: rgba(0,0,0,0.15);
  border-radius:16px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.25);
}

.canvas-tip {
  background: var(--blue-title, #2877cd);
  color: #fff;
  border-radius: 9999px;
  padding: 0.5rem 0.9rem;
  display: inline-block;
  margin-top: 0.75rem;
}

/* Mobile tweaks */
@media (max-width: 480px){
  .canvas-section h2{ font-size:1.05rem; }
  .btn, .file-btn{ padding:0.5rem 0.9rem; }
}

/* Smooth, light blend for top & bottom banners */
header, footer { position: relative; }

/* Top banner fade */
header::after {
  content: "";
  position: absolute;
  left: 0; right: 0; bottom: 0;
  height: 40px; /* shorter fade */
  pointer-events: none;
  background: linear-gradient(
    to bottom,
    rgba(189,233,255,0) 0%,
    rgba(189,233,255,0.3) 50%,
    rgba(189,233,255,0.85) 100%
  );
  z-index: 1;
}

/* Bottom banner fade */
footer::before {
  content: "";
  position: absolute;
  left: 0; right: 0; top: 0;
  height: 40px;
  pointer-events: none;
  background: linear-gradient(
    to top,
    rgba(189,233,255,0) 0%,
    rgba(189,233,255,0.3) 50%,
    rgba(189,233,255,0.85) 100%
  );
  z-index: 1;
}

/* Mobile: even shorter fades for tighter space */
@media (max-width: 480px) {
  header::after,
  footer::before { height: 28px; }
}

/* Green background for meme console buttons */
.meme-controls .btn,
.canvas-controls .btn {
  background: #28a745; /* green */
  color: #fff;
}
.meme-controls .btn:hover,
.canvas-controls .btn:hover {
  background: #23913c; /* darker green on hover */
}

/* Green styling for Upload, Download, Flip, Reset buttons */
.canvas-controls .btn,
.canvas-controls .file-btn {
  background: #28a745; /* green */
  color: #fff;
  border: none;
  border-radius: 9999px;
  padding: 0.55rem 1rem;
  font-weight: 700;
  cursor: pointer;
}
.canvas-controls .btn:hover,
.canvas-controls .file-btn:hover {
  background: #23913c; /* darker green */
}

/* Floating social buttons (left column, centered, fixed) */
.social-fab{
  position: fixed;
  left: calc((var(--colW) - 64px) / 2); /* center inside your 220px side strip */
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  flex-direction: column;
  gap: 12px;
  z-index: 4;            /* above hats(1) & side-columns(2), below header/main(3+ is fine) */
  pointer-events: auto;  /* ensure clickable (side-columns use pointer-events:none) */
}

.social-fab a{ display: block; }

.social-fab img{
  width: 64px;
  height: 64px;
  object-fit: contain;
  display: block;
  border-radius: 16px;
  background: #ffffff;              /* subtle tile look */
  box-shadow: 0 8px 20px rgba(0,0,0,0.25);
  transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
}
.social-fab img:hover{
  transform: translateY(-2px) scale(1.03);
  box-shadow: 0 12px 28px rgba(0,0,0,0.3);
  filter: saturate(1.04);
}

/* Desktop (already done) ... */

/* Mobile: fix under the top banner, smaller icons */
@media (max-width: 480px){
  .social-fab{
    position: fixed;
    left: 12px;                /* tuck to the left on mobile */
    top: calc(var(--headerH, 64px) + 8px); /* just below banner */
    transform: none;           /* cancel desktop centering */
    flex-direction: column;
    gap: 8px;
    z-index: 6;                /* above page content */
  }
  .social-fab img{
    width: 44px;
    height: 44px;
    border-radius: 12px;
    box-shadow: 0 8px 18px rgba(0,0,0,.22);
  }
}

/* === Title 3D look (non-intrusive) === */
:root{
  --titleBlue: var(--blue-title, #2877cd);
  --title-shadow-1: 0 4px 10px rgba(0,0,0,.18);
  --title-shadow-2: 0 8px 22px rgba(0,0,0,.22);
  --site-brightness: 1;            /* for the brightness slider */
  --page-bg: #bde9ff;              /* Light default page background */
  --text-color: #ffffff;
}
html{ filter: brightness(var(--site-brightness)); }

/* Dark mode variables */
html[data-theme="dark"]{
  --page-bg: #0f1724;              /* deep slate */
  --text-color: #e8eef7;
  /* keep brand blue but you can darken if you want */
  --titleBlue: #2877cd;
}

/* Ensure body uses theme background (override old body bg if needed) */
body{
  background: var(--page-bg) !important;
  color: var(--text-color);
}

/* Apply 3D pill style to all titles */
main > h1,
.app-section h2,
.jupiter-section h2,
.market-section h2,
.memes-section h2,
.canvas-section h2,
.canvas-tip{
  background: var(--titleBlue);
  color: #fff;
  display: inline-block;
  border-radius: 9999px;
  padding: .5rem .9rem;
  /* subtle embossed + drop shadow combo */
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.28),
    0 6px 14px rgba(0,0,0,.18);
  text-shadow: 0 1px 0 rgba(0,0,0,.2);
  transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
}
main > h1:hover,
.app-section h2:hover,
.jupiter-section h2:hover,
.market-section h2:hover,
.memes-section h2:hover,
.canvas-section h2:hover,
.canvas-tip:hover{
  transform: translateY(-2px);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.22),
    0 10px 28px rgba(0,0,0,.26);
}

/* === Appearance section styling (small control panel) === */
.appearance-section{
  width: 100%;
  max-width: 1200px;
}
.appearance-panel{
  margin-top: .5rem;
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
  align-items: center;
  justify-content: center;
}
.toggle{
  display: inline-flex;
  align-items: center;
  gap: .5rem;
  background: rgba(255,255,255,.18);
  color: #fff;
  border-radius: 9999px;
  padding: .4rem .8rem;
  box-shadow: 0 4px 12px rgba(0,0,0,.18);
}
html[data-theme="dark"] .toggle{ background: rgba(0,0,0,.25); }

.brightness{
  display: inline-flex;
  align-items: center;
  gap: .6rem;
  background: rgba(255,255,255,.18);
  color: #fff;
  border-radius: 9999px;
  padding: .4rem .8rem;
  box-shadow: 0 4px 12px rgba(0,0,0,.18);
}
html[data-theme="dark"] .brightness{ background: rgba(0,0,0,.25); }

.brightness input[type="range"]{
  width: 160px;
  accent-color: var(--titleBlue);
}

/* Keep controls readable above animated backgrounds */
.appearance-section{ position: relative; z-index: 3; }

.appearance-title {
  display: inline-block;
  padding: 0.5rem 0.9rem;
  background: #28a745; /* green */
  color: #fff;
  border-radius: 9999px;
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.28),
    0 6px 14px rgba(0,0,0,.18);
  text-shadow: 0 1px 0 rgba(0,0,0,.2);
}
.appearance-title:hover {
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.22),
    0 10px 28px rgba(0,0,0,.26);
  transform: translateY(-2px);
}

  </style>
</head>
<body>
  <header>
    <img src="marketcap-banner.png" alt="Marketcap banner" loading="eager" />
  </header>

  <div class="hat-bg" aria-hidden="true">
    <script>
      const hats = ["hat1.png","hat2.png","hat3.png","hat4.png","hat5.png","hat6.png","hat7.png","hat8.png","hat9.png","hat10.png"];
      for(let i=0;i<40;i++){
        const img=document.createElement('img');
        img.src=hats[i % hats.length];
        document.currentScript.parentNode.appendChild(img);
      }
    </script>
  </div>

  <div id="side-columns" aria-hidden="true">
    <div class="col left"></div>
    <div class="col right"></div>
  </div>

  <main>
    <h1>All the markets need the §MCAP</h1>

    <div class="app-section">
      <h2>Buy your cap, the market isn't waiting</h2>
      <div class="app-launch-wrap">
        <a class="app-launch" href="https://themarketingisinthemcap.com/" target="_blank" rel="noopener noreferrer">
          <img src="buy.png" alt="Open App" />
          <span>Open the app</span>
        </a>
      </div>
    </div>

    <div class="jupiter-section">
  <h2>Buy $MCAP directly with Jupiter</h2>
  <div class="app-launch-wrap">
    <a class="app-launch" href="javascript:void(0)" id="open-jup">
      <img src="jupiter.png" alt="Open Jupiter Swap" />
      <span>Open Swap</span>
    </a>
  </div>
<script>
(function(){
  let jupInited = false;
  let jupInitPromise = null;

  function ensureJupiter(){
    if (jupInited) return jupInitPromise;
    if (!window.Jupiter) return Promise.reject(new Error('Jupiter not loaded'));

    jupInited = true;
    jupInitPromise = window.Jupiter.init({
      displayMode: 'modal',
      formProps: {
        initialInputMint: 'So11111111111111111111111111111111111111112', // SOL
        initialOutputMint: 'HTJjDuxxnxHGoKTiTYLMFQ59gFjSBS3bXiCWJML6bonk'
      }
    });
    return jupInitPromise;
  }

  window.addEventListener('load', function(){
    // Bind ONLY the explicit trigger(s)
    const trigger = document.getElementById('open-jup')
      || document.querySelector('.jupiter-section .app-launch, .jupiter-section img');

    if (trigger) {
      trigger.addEventListener('click', async function(e){
        e.preventDefault();
        try {
          await ensureJupiter();            // init on first click (no auto-open before)
          if (window.Jupiter?.resume) window.Jupiter.resume();
        } catch(err){
          console.error('Jupiter not ready:', err);
        }
      });
    }
  });
})();
</script>
</div>

<div class="social-fab">
  <a href="https://t.me/theMcap" target="_blank" rel="noopener noreferrer" aria-label="Join MCAP on Telegram">
    <img src="telegram.png" alt="Telegram">
  </a>
  <a href="https://x.com/Mcapmovement" target="_blank" rel="noopener noreferrer" aria-label="Follow MCAP on X">
    <img src="x_image.png" alt="X (Twitter)">
  </a>
</div>

    <section class="market-section">
      <h2>In the cap we believe</h2>
      <div id="dexscreener-embed">
        <iframe src="https://dexscreener.com/solana/8dfgrJBLqbnyfitUML6K43sxBKtz3xh3nx6mRYs6rEK7?embed=1&loadChartSettings=0&trades=0&chartLeftToolbar=0&chartTheme=dark&theme=dark&chartStyle=0&chartType=usd&interval=15"></iframe>
      </div>
    </section>

   <div class="memes-section">
  <h2>$MCAP MEMES</h2>
  <div class="memes-scroll">
    <div class="memes-track">
      <!-- First set -->
      <img src="meme1.png" alt="Meme 1">
      <img src="meme2.png" alt="Meme 2">
      <img src="meme3.png" alt="Meme 3">
      <img src="meme4.png" alt="Meme 4">
      <img src="meme5.png" alt="Meme 5">
      <img src="meme6.png" alt="Meme 6">
      <img src="meme7.png" alt="Meme 7">
      <img src="meme8.png" alt="Meme 8">
      <img src="meme9.png" alt="Meme 9">
      <!-- Duplicate set for seamless loop -->
      <img src="meme1.png" alt="Meme 1">
      <img src="meme2.png" alt="Meme 2">
      <img src="meme3.png" alt="Meme 3">
      <img src="meme4.png" alt="Meme 4">
      <img src="meme5.png" alt="Meme 5">
      <img src="meme6.png" alt="Meme 6">
      <img src="meme7.png" alt="Meme 7">
      <img src="meme8.png" alt="Meme 8">
      <img src="meme9.png" alt="Meme 9">
    </div>
  </div>
</div>


<!-- Fullscreen modal for meme -->
<div id="meme-modal">
  <span id="meme-close">&times;</span>
  <img id="meme-full" src="" alt="Expanded Meme">
</div>


<!-- Fullscreen modal for meme -->
<div id="meme-modal">
  <span id="meme-close">&times;</span>
  <img id="meme-full" src="" alt="Expanded Meme">
</div>
<script>
  // Meme modal logic
  const memeModal = document.getElementById('meme-modal');
  const memeFull = document.getElementById('meme-full');
  const memeClose = document.getElementById('meme-close');

  document.querySelectorAll('.memes-scroll img').forEach(img => {
    img.addEventListener('click', () => {
      memeFull.src = img.src;
      memeModal.style.display = 'flex';
    });
  });

  memeClose.addEventListener('click', () => {
    memeModal.style.display = 'none';
  });

  memeModal.addEventListener('click', (e) => {
    if (e.target === memeModal) {
      memeModal.style.display = 'none';
    }
  });
</script>

<section class="canvas-section">
  <h2 style="background: var(--blue-title, #2877cd); color: #fff;">
    Put on your MCAP, and join the cult
  </h2>

  <div class="canvas-controls">
  <label class="file-btn">
    <input type="file" id="imgUpload" accept="image/png,image/jpeg" />
    Upload PNG/JPG
  </label>
  <button id="downloadBtn" class="btn">Download</button>
  <button id="flipHatBtn" class="btn">Flip image</button>
  <button id="addHatBtn" class="btn">Add hat.png</button>
  <button id="resetHatBtn" class="btn btn-ghost">Reset</button>
</div>


  <div class="canvas-wrap">
    <canvas id="hatCanvas" width="900" height="600" aria-label="Hat editor canvas"></canvas>
  </div>
  <p class="canvas-tip">
    Desktop: drag to move • Mouse wheel: scale • Alt + wheel: rotate
    <br>Mobile: 1-finger drag • 2-finger pinch to scale & rotate
  </p>
</section>
<script>
(function(){
  const canvas = document.getElementById('hatCanvas');
  const ctx = canvas.getContext('2d');

  // HiDPI canvas scale for crispness
  function setupHiDPI(){
    const ratio = window.devicePixelRatio || 1;
    const cssW = canvas.clientWidth;
    const cssH = canvas.clientHeight;
    canvas.width  = Math.round(cssW * ratio);
    canvas.height = Math.round(cssH * ratio);
    ctx.setTransform(ratio,0,0,ratio,0,0);
  }
  setupHiDPI();
  window.addEventListener('resize', () => {
    setupHiDPI();
    fitBaseToCanvas();
    draw();
  });

  // Elements
  const upload = document.getElementById('imgUpload');
  const addHatBtn = document.getElementById('addHatBtn');
  const resetHatBtn = document.getElementById('resetHatBtn');

  // Base image state
  let baseImg = null;
  let baseDraw = { x:0, y:0, w:0, h:0 }; // fitted rect

  // Hat state
  let hatImg = new Image();
  hatImg.src = 'hat.png';
  let hat = {
  x: 0, y: 0,
  w: 220, h: 160,
  scale: 1,
  rot: 0,
  visible: false,
  flipX: 1 // +1 normal, -1 flipped
};

  // Pointer state
  let dragging = false;
  let lastPos = null;

  // Multi-touch state
  let touches = new Map(); // id -> {x,y}
  let pinchStart = null;   // {dist, angle, cx, cy, scale0, rot0, x0, y0}

  // Utility
  function getMousePos(evt){
    const rect = canvas.getBoundingClientRect();
    return {
      x: (evt.clientX - rect.left),
      y: (evt.clientY - rect.top)
    };
  }
  function getTouchPos(t){
    const rect = canvas.getBoundingClientRect();
    return {
      x: (t.clientX - rect.left),
      y: (t.clientY - rect.top)
    };
  }
  function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }
  function angle(a,b){ return Math.atan2(b.y-a.y, b.x-a.x); }
  function mid(a,b){ return { x:(a.x+b.x)/2, y:(a.y+b.y)/2 }; }

  // Fit base image to canvas
  function fitBaseToCanvas(){
    if(!baseImg) return;
    const cw = canvas.clientWidth, ch = canvas.clientHeight;
    const ir = baseImg.width / baseImg.height;
    const cr = cw / ch;
    let w,h,x,y;
    if(ir > cr){ // image wider
      w = cw; h = cw / ir;
      x = 0;  y = (ch - h)/2;
    } else {
      h = ch; w = ch * ir;
      x = (cw - w)/2; y = 0;
    }
    baseDraw = {x,y,w,h};
  }

  // Drawing
  function draw(){
    // clear
    ctx.clearRect(0,0,canvas.clientWidth, canvas.clientHeight);

    // base
    if(baseImg){
      ctx.drawImage(baseImg, baseDraw.x, baseDraw.y, baseDraw.w, baseDraw.h);
    }

    // hat
    if(hat.visible && hatImg.complete){
      ctx.save();
      ctx.translate(hat.x, hat.y);
      ctx.rotate(hat.rot);
      ctx.scale(hat.flipX, 1); // <-- horizontal flip
      const dw = hat.w * hat.scale;
      const dh = hat.h * hat.scale;
      ctx.drawImage(hatImg, -dw/2, -dh/2, dw, dh);
      ctx.restore();
    }
  }

  // Hit test: point inside current hat rect
  function hitHat(p){
    if(!hat.visible) return false;
    // inverse transform point into hat local space
    const s = Math.sin(-hat.rot), c = Math.cos(-hat.rot);
    const dx = p.x - hat.x, dy = p.y - hat.y;
    const lx = dx * c - dy * s;
    const ly = dx * s + dy * c;
    const hw = (hat.w * hat.scale)/2;
    const hh = (hat.h * hat.scale)/2;
    return Math.abs(lx) <= hw && Math.abs(ly) <= hh;
  }

  // Download canvas as PNG
document.getElementById('downloadBtn').addEventListener('click', () => {
  const link = document.createElement('a');
  link.download = 'mcap-hat.png';
  link.href = canvas.toDataURL('image/png');
  link.click();
});

document.getElementById('flipHatBtn').addEventListener('click', () => {
  hat.flipX *= -1; // toggle
  draw();
});

  // Image upload
  upload.addEventListener('change', e=>{
    const file = upload.files && upload.files[0];
    if(!file) return;
    const img = new Image();
    img.onload = ()=>{
      baseImg = img;
      fitBaseToCanvas();
      // Place hat at center if not visible
      if(!hat.visible){
        hat.x = canvas.clientWidth/2;
        hat.y = canvas.clientHeight/2;
      }
      draw();
    };
    img.src = URL.createObjectURL(file);
  });

  // Add hat
  addHatBtn.addEventListener('click', ()=>{
    hat.visible = true;
    hat.scale = 1;
    hat.rot = 0;
    hat.x = canvas.clientWidth/2;
    hat.y = canvas.clientHeight/2;
    draw();
  });

 // Reset
resetHatBtn.addEventListener('click', () => {
  // Clear everything from canvas
  ctx.clearRect(0, 0, canvas.clientWidth, canvas.clientHeight);

  // Remove base image and hide hat
  baseImg = null;
  hat.visible = false;
  hat.scale = 1;
  hat.rot = 0;
  hat.x = canvas.clientWidth / 2;
  hat.y = canvas.clientHeight / 2;
  hat.flipX = 1; // if you have flip functionality

  draw();
});

  // Mouse interactions
  canvas.addEventListener('mousedown', e=>{
    const p = getMousePos(e);
    if(hitHat(p)){ dragging = true; lastPos = p; e.preventDefault(); }
  });
  window.addEventListener('mousemove', e=>{
    if(!dragging) return;
    const p = getMousePos(e);
    const dx = p.x - lastPos.x;
    const dy = p.y - lastPos.y;
    hat.x += dx; hat.y += dy;
    lastPos = p;
    draw();
  });
  window.addEventListener('mouseup', ()=>{ dragging=false; });

  // Mouse wheel: scale (Alt+wheel = rotate)
  canvas.addEventListener('wheel', e=>{
    e.preventDefault();
    const over = getMousePos(e);
    if(!hitHat(over)) return;
    if(e.altKey){
      hat.rot += (-e.deltaY) * 0.0025; // rotate
    }else{
      const s = Math.exp((-e.deltaY) * 0.001); // scale smoothly
      hat.scale = Math.max(0.1, Math.min(8, hat.scale * s));
    }
    draw();
  }, {passive:false});

  // Keyboard precision
  window.addEventListener('keydown', e=>{
    let nudge = 1;
    if(e.shiftKey) nudge = 5;
    switch(e.key){
      case 'ArrowUp':   hat.y -= nudge; draw(); break;
      case 'ArrowDown': hat.y += nudge; draw(); break;
      case 'ArrowLeft': hat.x -= nudge; draw(); break;
      case 'ArrowRight':hat.x += nudge; draw(); break;
      case '[': hat.rot -= 0.03; draw(); break;
      case ']': hat.rot += 0.03; draw(); break;
      case '+':
      case '=': hat.scale = Math.min(8, hat.scale*1.05); draw(); break;
      case '-': hat.scale = Math.max(0.1, hat.scale/1.05); draw(); break;
    }
  });

  // Touch interactions (prevent page zoom/scroll while interacting)
  function preventDefaultAll(e){ e.preventDefault(); }
  ['touchstart','touchmove','touchend','touchcancel'].forEach(type=>{
    canvas.addEventListener(type, preventDefaultAll, {passive:false});
  });

  canvas.addEventListener('touchstart', e=>{
    for(const t of e.changedTouches){
      touches.set(t.identifier, getTouchPos(t));
    }
    if(touches.size === 1){
      const p = touches.values().next().value;
      if(hitHat(p)){ dragging = true; lastPos = p; }
    } else if(touches.size === 2){
      const [a,b] = [...touches.values()];
      pinchStart = {
        dist: dist(a,b),
        angle: angle(a,b),
        center: mid(a,b),
        scale0: hat.scale,
        rot0: hat.rot,
        x0: hat.x,
        y0: hat.y
      };
    }
  }, {passive:false});

  canvas.addEventListener('touchmove', e=>{
    for(const t of e.changedTouches){
      touches.set(t.identifier, getTouchPos(t));
    }
    if(touches.size === 1 && dragging){
      const p = touches.values().next().value;
      const dx = p.x - lastPos.x;
      const dy = p.y - lastPos.y;
      hat.x += dx; hat.y += dy;
      lastPos = p;
      draw();
    } else if(touches.size === 2 && pinchStart){
      const [a,b] = [...touches.values()];
      const newDist = dist(a,b);
      const newAngle = angle(a,b);
      const newCenter = mid(a,b);

      // scale & rotate
      const scaleFactor = newDist / pinchStart.dist;
      hat.scale = Math.max(0.1, Math.min(8, pinchStart.scale0 * scaleFactor));
      hat.rot = pinchStart.rot0 + (newAngle - pinchStart.angle);

      // translate following center movement
      hat.x = pinchStart.x0 + (newCenter.x - pinchStart.center.x);
      hat.y = pinchStart.y0 + (newCenter.y - pinchStart.center.y);
      draw();
    }
  }, {passive:false});

  canvas.addEventListener('touchend', e=>{
    for(const t of e.changedTouches){ touches.delete(t.identifier); }
    if(touches.size < 2) pinchStart = null;
    if(touches.size === 0){ dragging = false; lastPos = null; }
  });

  canvas.addEventListener('touchcancel', e=>{
    touches.clear(); dragging=false; pinchStart=null; lastPos=null;
  });

  // Initial draw (empty)
  draw();
})();
</script>

<section class="appearance-section">
  <h2 class="appearance-title">Customize your MCAP experience</h2>
  <div class="appearance-panel">
    <label class="toggle" title="Toggle light/dark">
      <input id="themeToggle" type="checkbox" style="accent-color:#2877cd;">
      Dark mode
    </label>

    <label class="brightness" title="Adjust overall brightness">
      <span>Brightness</span>
      <input id="brightnessSlider" type="range" min="75" max="115" value="100">
      <span id="brightnessValue">100%</span>
    </label>
  </div>
</section>
<script>
(function(){
  const html = document.documentElement;
  const themeToggle = document.getElementById('themeToggle');
  const slider = document.getElementById('brightnessSlider');
  const valueEl = document.getElementById('brightnessValue');

  // Load saved prefs
  const savedTheme = localStorage.getItem('mcap-theme');
  const savedBrightness = localStorage.getItem('mcap-brightness');

  // Default: light
  if(savedTheme === 'dark'){ html.setAttribute('data-theme','dark'); themeToggle.checked = true; }

  if(savedBrightness){
    const v = +savedBrightness;
    html.style.setProperty('--site-brightness', (v/100).toString());
    slider.value = v;
    valueEl.textContent = v + '%';
  }

  // Toggle theme
  themeToggle.addEventListener('change', ()=>{
    if(themeToggle.checked){
      html.setAttribute('data-theme','dark');
      localStorage.setItem('mcap-theme','dark');
    }else{
      html.removeAttribute('data-theme');
      localStorage.setItem('mcap-theme','light');
    }
  });

  // Brightness slider (75%–115%)
  slider.addEventListener('input', ()=>{
    const v = +slider.value;            // 75..115
    html.style.setProperty('--site-brightness', (v/100).toString());
    valueEl.textContent = v + '%';
  });
  slider.addEventListener('change', ()=>{
    localStorage.setItem('mcap-brightness', slider.value);
  });
})();
</script>


  </main>

  <footer>
    <img src="mcap-end.png" alt="MCAP end banner" />
  </footer>
</body>
</html>


